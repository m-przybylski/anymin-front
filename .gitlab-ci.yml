stages:
  - test-prepare-code
  - test-run

variables:
  # Update from $CI_COMMIT_SHA to $CI_PIPELINE_IID when gitlab > v.11
  CONTAINER_TEST_IMAGE_URL: eu.gcr.io/dev-country-188109/profitelo-frontend:test-$CI_COMMIT_SHA
  CONTAINER_RELEASE_IMAGE_URL: eu.gcr.io/dev-country-188109/profitelo-frontend:dev-$CI_COMMIT_SHA

test-prepare-code:
  stage: test-prepare-code
  except:
    - develop
  script:
    - docker build --no-cache -t $CONTAINER_TEST_IMAGE_URL -f Dockerfile.test .
  tags:
    - shell

build-release-image:
  when: manual
  stage: build-push-release-image
  script:
    - docker run -i $CONTAINER_TEST_IMAGE_URL /bin/sh -c 'npm install && npm run ci-test' && docker rmi -f $CONTAINER_TEST_IMAGE_URL
  tags:
    - shell

release-deploy:
  stage: release-deploy
  before_script:
    - mkdir -p /opt/anymind/deploy
    - helm init --service-account default
    - git clone git@git.contactis.pl:itelo/anymind-deployment.git /opt/anymind/deploy
  script:
    - docker run -i $CONTAINER_TEST_IMAGE /bin/sh -c 'npm run ci-test'
  after_script:
    - docker rm $CONTAINER_TEST_IMAGE
  tags:
    - shell
